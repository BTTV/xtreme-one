(function(){var a=tinymce.dom.Event;tinymce.create("tinymce.plugins.XtremeContentWidgets",{init:function(b,c){var d=this;d.editor=b;d.url=c;d.init_ready=false;d.supportedWidgets=b.getParam("xtreme_tinymce_widgets_supported","[]");d.post_ID=editor.getParam("post_ID",false);d._createButtons();b.onNodeChange.add(function(g,f,h){if(h.nodeName=="IMG"&&g.dom.getAttrib(h,"class").indexOf("mcexcontentwidget")!=-1){f.setActive("xtreme_tinymce_widgets",false);f.setDisabled("xtreme_tinymce_widgets",true);if(p=g.dom.getParent(h,"p")){var j=new RegExp("align(none|left|right|center)","g").exec(g.dom.getAttrib(p,"class"));if(j){var i=g.dom.getAttrib(h,"title");tc=i.replace(/align=(none|left|right|center)/g,"align="+j[1]);g.dom.setAttrib(h,"title",tc);g.plugins.xtreme_tinymce_widgets._define_margin_buttons(g,h);if(tc!=i){g.execCommand("mceRepaint")}}}}else{f.setActive("xtreme_tinymce_widgets",true);f.setDisabled("xtreme_tinymce_widgets",false)}});b.onMouseDown.add(function(f,g){if(g.target.nodeName=="IMG"&&f.dom.hasClass(g.target,"mcexcontentwidget")){f.plugins.xtreme_tinymce_widgets._showButtons(g.target,"xf_edit_buttons")}else{f.plugins.xtreme_tinymce_widgets._hideButtons()}});b.onBeforeExecCommand.add(function(e,g,f,h){d._hideButtons()});b.onInit.add(function(e){tinymce.dom.Event.add(e.getWin(),"scroll",function(f){d._hideButtons()})});b.onSaveContent.add(function(e,f){d._hideButtons()});b.onBeforeSetContent.add(function(e,f){f.content=d._do_widget(f.content)});b.onPostProcess.add(function(e,f){if(f.get){f.content=d._get_widget(f.content)}});if(!d.supportedWidgets.permission){return}b.addCommand("mceInsertWidget",function(f,e){e=d._do_widget(e);b.execCommand("mceInsertContent",f,e)});b.addCommand("mceReplaceWidget",function(f,e){e=d._do_widget(e);b.execCommand("mceReplaceContent",f,e)})},_do_widget:function(c){function b(d,e){e=new RegExp(e+"=([^ ]+)","g").exec(d);return e?tinymce.DOM.decode(e[1]):""}return c.replace(/(?:<p>)?\[(xwidgetwordpress|xwidget3rdparty|xwidgetxtreme)([^\]]*)\](?:<\/p>)?/g,function(e,d,j){var i=b(j,"align");var f=b(j,"width");var h=b(j,"sidemargins");var g="";if(i){if(i=="left"&&h=="off"){g="margin-right:0;"}if(i=="right"&&h=="off"){g="margin-left:0;"}i="align"+i}if(f&&f!="auto"){g=g+"width:"+f+";"}if(g.length>0){g=' style="'+g+'"'}return'<p class="'+i+'"'+g+'><img src="'+tinyMCE.activeEditor.plugins.xtreme_tinymce_widgets.url+'/img/t.gif" class="mcexcontentwidget mceItem mceTemp mce'+d+' mceItemNoResize mceNonEditable" title="'+d+""+tinymce.DOM.encode(j)+'" /></p>'})},_get_widget:function(c){function b(d,e){e=new RegExp(e+'="([^"]+)"',"g").exec(d);return e?tinymce.DOM.decode(e[1]):""}return c.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(f,e){var d=b(e,"class");if(d.indexOf("mcexcontentwidget")!=-1){var g=tinymce.trim(b(e,"title"));return"<p>["+g+"]</p>"}return f})},createControl:function(g,b){if(!this.post_ID){return}var e=this,d=this.post_ID;switch(g){case"xtreme_tinymce_widgets":var f=b.createSplitButton("xtreme_tinymce_widgets",{title:"WordPress Widgets",image:e.url+"/img/widget.png"});f.onRenderMenu.add(function(i,h){h.add({title:e.supportedWidgets.mainmenu.title,"class":"mceMenuItemTitle"}).setDisabled(1);tinymce.each(e.supportedWidgets.mainmenu.submenus,function(c){var j=h.addMenu({title:c.title,max_height:250,"class":"mceSplitButtonMenu mceListBoxMenu mceNoIcons wp_themeSkin"});j.add({title:c.subtitle,"class":"mceMenuItemTitle"}).setDisabled(1);tinymce.each(c.items,function(k){j.add({title:k.title,onclick:function(){e.editor.windowManager.open({file:"admin-ajax.php?action=mce_xcontentwidget&action2=insert&widget_class="+k.widget+"&post_id="+d,width:620,height:500,inline:1,title:k.title},{plugin_url:e.url})}})})})});return f}return null},_createButtons:function(){if(!this.post_ID){return}var d=this,b=tinyMCE.activeEditor,f=tinymce.DOM,g,e,c=this.post_ID;f.remove("xf_edit_buttons");if(!d.supportedWidgets.permission){return}f.add(document.body,"div",{id:"xf_edit_buttons",style:"display:none;"});g=f.add("xf_edit_buttons","img",{src:d.url+"/img/edit.png",id:"xf_editwidget",width:"24",height:"24",title:d.supportedWidgets.buttons.edit});tinymce.dom.Event.add(g,"mousedown",function(o){var l=tinyMCE.activeEditor;var h=l.selection.getNode();if(h.nodeName!="IMG"){return}if(l.dom.getAttrib(h,"class").indexOf("mcexcontentwidget")==-1){return}l.plugins.xtreme_tinymce_widgets._hideButtons();var i=new RegExp("id=(\\d+).(\\d+)","g").exec(l.dom.getAttrib(h,"title"));var k=i?tinymce.DOM.decode(i[1]):c;var s=i?tinymce.DOM.decode(i[2]):"0";i=new RegExp("align=(none|left|right|center)","g").exec(l.dom.getAttrib(h,"title"));var q=i?tinymce.DOM.decode(i[1]):"none";i=new RegExp("width=([^ ]+)","g").exec(l.dom.getAttrib(h,"title"));var r=i?tinymce.DOM.decode(i[1]):"auto";i=new RegExp("sidemargins=([^ ]+)","g").exec(l.dom.getAttrib(h,"title"));var j=i?tinymce.DOM.decode(i[1]):"on";d.editor.windowManager.open({file:"admin-ajax.php?action=mce_xcontentwidget&action2=update&widget_id="+s+"&post_id="+k+"&align="+q+"&width="+r+"&sidemargins="+j,width:620,height:500,inline:1,title:""},{plugin_url:d.url})});alignleftButton=f.add("xf_edit_buttons","img",{src:d.url+"/img/t.gif",id:"xf_widget_a_left",width:"24",height:"24",title:d.supportedWidgets.buttons.margin_r});tinymce.dom.Event.add(alignleftButton,"mousedown",function(l){var k=tinymce.DOM;var i=tinyMCE.activeEditor,j=i.selection.getNode();sc=i.dom.getAttrib(j,"title");n=new RegExp("sidemargins=([^ ]+)","g").exec(i.dom.getAttrib(j,"title"));var h=n?tinymce.DOM.decode(n[1]):"on";if(h=="on"){tc=sc.replace(/sidemargins=([^ ]+)/g,"sidemargins=off");i.dom.setAttrib(j,"title",tc)}else{tc=sc.replace(/sidemargins=([^ ]+)/g,"sidemargins=on");i.dom.setAttrib(j,"title",tc)}i.plugins.xtreme_tinymce_widgets._define_margin_buttons(i,j);i.execCommand("mceRepaint")});alignrightButton=f.add("xf_edit_buttons","img",{src:d.url+"/img/t.gif",id:"xf_widget_a_right",width:"24",height:"24",title:d.supportedWidgets.buttons.margin_l});tinymce.dom.Event.add(alignrightButton,"mousedown",function(l){var k=tinymce.DOM;var i=tinyMCE.activeEditor,j=i.selection.getNode();sc=i.dom.getAttrib(j,"title");n=new RegExp("sidemargins=([^ ]+)","g").exec(i.dom.getAttrib(j,"title"));var h=n?tinymce.DOM.decode(n[1]):"on";if(h=="on"){tc=sc.replace(/sidemargins=([^ ]+)/g,"sidemargins=off");i.dom.setAttrib(j,"title",tc)}else{tc=sc.replace(/sidemargins=([^ ]+)/g,"sidemargins=on");i.dom.setAttrib(j,"title",tc)}i.plugins.xtreme_tinymce_widgets._define_margin_buttons(i,j);i.execCommand("mceRepaint")});delButton=f.add("xf_edit_buttons","img",{src:d.url+"/img/delete.png",id:"xf_delwidget",width:"24",height:"24",title:d.supportedWidgets.buttons.del});tinymce.dom.Event.add(delButton,"mousedown",function(j){var h=tinyMCE.activeEditor,i=h.selection.getNode();if(i.nodeName=="IMG"&&h.dom.hasClass(i,"mcexcontentwidget")){if(p=h.dom.getParent(i,"p")){h.dom.remove(p)}else{h.dom.remove(i)}h.execCommand("mceRepaint");return false}})},_define_margin_buttons:function(d,e){var f=tinymce.DOM;n=new RegExp("align=(none|left|right|center)","g").exec(d.dom.getAttrib(e,"title"));var c=n?tinymce.DOM.decode(n[1]):"none";n=new RegExp("sidemargins=([^ ]+)","g").exec(d.dom.getAttrib(e,"title"));var b=n?tinymce.DOM.decode(n[1]):"on";var g=d.dom.getParent(e,"p");f.setStyles("xf_widget_a_left",{display:"none"});f.setStyles("xf_widget_a_right",{display:"none"});switch(c){case"left":f.setStyles("xf_widget_a_left",{display:"inline"});if(b=="off"){f.addClass("xf_widget_a_left","off");d.dom.setStyles(g,{"margin-left":"","margin-right":"0"})}else{f.removeClass("xf_widget_a_left","off");d.dom.setStyles(g,{"margin-left":"","margin-right":""})}break;case"right":f.setStyles("xf_widget_a_right",{display:"inline"});if(b=="off"){f.addClass("xf_widget_a_right","off");d.dom.setStyles(g,{"margin-left":"0","margin-right":""})}else{f.removeClass("xf_widget_a_right","off");d.dom.setStyles(g,{"margin-left":"","margin-right":""})}break;default:d.dom.setStyles(g,{"margin-left":"","margin-right":""});break}},_showButtons:function(f,d){var g=tinyMCE.activeEditor,i,h,b,j=tinymce.DOM,e,c;if(!g.plugins.xtreme_tinymce_widgets.supportedWidgets.permission){return}g.plugins.xtreme_tinymce_widgets._define_margin_buttons(g,f);b=g.dom.getViewPort(g.getWin());i=j.getPos(g.getContentAreaContainer());h=g.dom.getPos(f);e=Math.max(h.x-b.x,0)+i.x;c=Math.max(h.y-b.y,0)+i.y;j.setStyles(d,{top:c+5+"px",left:e+5+"px",display:"block"});if(this.mceTout){clearTimeout(this.mceTout)}this.mceTout=setTimeout(function(){g.plugins.xtreme_tinymce_widgets._hideButtons()},5000)},_hideButtons:function(){if(!this.mceTout){return}if(document.getElementById("xf_edit_buttons")){tinymce.DOM.hide("xf_edit_buttons")}clearTimeout(this.mceTout);this.mceTout=0},getInfo:function(){return{longname:"WP TinyMCE Xtreme Content Widgets",author:"Heiko Rabe",authorurl:"http://www.code-styling.de",infourl:"http://www.code-styling.de",version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add("xtreme_tinymce_widgets",tinymce.plugins.XtremeContentWidgets)})();